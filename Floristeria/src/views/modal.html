<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Modal Historial de Cliente</title>
  <link rel="stylesheet" href="../styles/componentes/modal.css">
  <link rel="stylesheet" href="../styles/pedidos.css">
  <link rel="stylesheet" href="../styles/componentes/tables.css">
  <link rel="stylesheet" href="../styles/componentes/button.css">
</head>
<body>
<!-- Modal Historial de Cliente -->
<!-- Modal Producto -->
<div id="modal-producto" class="modal">
  <div class="modal-content">
    <div class="modal-header" style="padding: 1.2rem 1.8rem 0.8rem 1.8rem;">
      <div>
        <h2 class="modal-title-pro" style="font-size: 1.5rem; margin-bottom: 0.2rem;">ðŸŒ¸ Alta de Producto</h2>
        <p class="modal-subtitle-pro" style="font-size: 0.85rem;">Completa los datos para registrar un nuevo producto en tu inventario</p>
      </div>
      <button type="button" class="modal-close" onclick="app.hideModal('modal-producto')" style="
        position: absolute;
        top: 1rem;
        right: 1.2rem;
        background: none;
        border: none;
        font-size: 1.8rem;
        cursor: pointer;
        color: #6b7280;
        transition: color 0.2s;
        line-height: 1;
        padding: 0.2rem;
      ">&times;</button>
    </div>
    <div class="modal-body" style="padding: 1rem 1.8rem; max-height: 60vh; overflow-y: auto;">
      <form id="form-producto" class="form">
        <!-- Fila 1: Nombre y CÃ³digo -->
        <div class="form-row">
          <div class="form-group" style="flex:2 1 60%; min-width:180px;">
            <label for="producto-nombre">Nombre *</label>
            <input type="text" id="producto-nombre" name="nombre" required>
          </div>
          <div class="form-group" style="flex:1 1 35%; min-width:120px;">
            <label for="producto-codigo">CÃ³digo de Producto</label>
            <input type="text" id="producto-codigo" name="codigo_producto" readonly style="background:#f3f4f6;cursor:not-allowed;" value="">
          </div>
        </div>
        <!-- Fila 2: CategorÃ­a, Temporada, Precio Compra, Precio Venta -->
        <div class="form-row">
          <div class="form-group">
            <label for="producto-categoria">CategorÃ­a *</label>
            <select id="producto-categoria" name="categoria_id" required>
              <option value="">Seleccionar...</option>
            </select>
          </div>
          <div class="form-group">
            <label for="producto-temporada">Temporada</label>
            <select id="producto-temporada" name="temporada">
              <option value="todo_aÃ±o">Todo el aÃ±o</option>
              <option value="primavera">Primavera</option>
              <option value="verano">Verano</option>
              <option value="otoÃ±o">OtoÃ±o</option>
              <option value="invierno">Invierno</option>
            </select>
          </div>
          <div class="form-group">
            <label for="producto-precio-compra">Precio Compra (â‚¬)</label>
            <input type="number" id="producto-precio-compra" name="precio_compra" step="0.01">
          </div>
          <div class="form-group">
            <label for="producto-precio-venta">Precio Venta (â‚¬) *</label>
            <input type="number" id="producto-precio-venta" name="precio_venta" step="0.01" required>
          </div>
        </div>
        <!-- Fila 3: Stock Actual y Stock MÃ­nimo -->
        <div class="form-row">
          <div class="form-group">
            <label for="producto-stock">Stock Actual</label>
            <input type="number" id="producto-stock" name="stock_actual" value="0">
          </div>
          <div class="form-group">
            <label for="producto-stock-minimo">Stock MÃ­nimo</label>
            <input type="number" id="producto-stock-minimo" name="stock_minimo" value="5">
          </div>
        </div>
        <!-- Fila 4: DescripciÃ³n -->
        <div class="form-group" style="margin-top:1rem;">
          <label for="producto-descripcion">DescripciÃ³n</label>
          <textarea id="producto-descripcion" name="descripcion" rows="3"></textarea>
        </div>
        <!-- Fila 5: BotÃ³n -->
    </div>
    <div class="modal-footer">
        <button type="submit" class="btn btn-primary">
        ðŸ’¾ Guardar Producto
        </button>
    </div>
      </form>
      <!-- SCRIPT para cÃ³digo de producto -->
      <script>
      // Generar cÃ³digo de producto tipo XX-001 segÃºn el nombre y que no coincida con productos existentes
      async function generarCodigoProducto(nombre) {
        if (!nombre) return '';
        // Obtener iniciales (primeras letras de cada palabra, mÃ¡x 2)
        const palabras = nombre.trim().split(/\s+/);
        let iniciales = palabras.map(p => p[0].toUpperCase()).join('');
        iniciales = iniciales.slice(0,2);
        // Si termina en guion, lo quitamos
        iniciales = iniciales.replace(/-+$/,'');
        // Obtener productos existentes (window.flowerShopAPI)
        let usados = [];
        if (window.flowerShopAPI && window.flowerShopAPI.getProductos) {
          try {
            const productos = await window.flowerShopAPI.getProductos();
            usados = productos.map(p => (p.codigo_producto || '').toUpperCase());
          } catch {}
        }
        // Buscar el primer nÃºmero libre
        let n = 1;
        let codigo = '';
        do {
          codigo = `${iniciales}-${String(n).padStart(3,'0')}`;
          n++;
        } while (usados.includes(codigo));
        return codigo;
      }
      document.addEventListener('DOMContentLoaded', function() {
        const inputNombre = document.getElementById('producto-nombre');
        const inputCodigo = document.getElementById('producto-codigo');
        // Generar cÃ³digo al escribir el nombre
        if (inputNombre && inputCodigo) {
          inputNombre.addEventListener('input', async function() {
            const nombre = inputNombre.value;
            if (nombre.length > 0) {
              inputCodigo.value = '...';
              const codigo = await generarCodigoProducto(nombre);
              inputCodigo.value = codigo;
            } else {
              inputCodigo.value = '';
            }
          });
        }
        // Al abrir el modal, si hay nombre, generar cÃ³digo
        const btn = document.getElementById('btn-nuevo-producto');
        if (btn && inputNombre && inputCodigo) {
          btn.addEventListener('click', function() {
            setTimeout(async function() {
              if (inputNombre.value.length > 0) {
                inputCodigo.value = '...';
                const codigo = await generarCodigoProducto(inputNombre.value);
                inputCodigo.value = codigo;
              } else {
                inputCodigo.value = '';
              }
            }, 100);
          });
        }
      });
      </script>
    </div>
  </div>
</div>
</body>
</html>